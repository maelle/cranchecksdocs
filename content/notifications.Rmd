---
weight: 22
title: Notifications
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
source("hooks.R")
```

# Notifications

The Notifications endpoint allow you to manage notifications sent to your email address, so you might get aware of failing CRAN checks before CRAN emails you! :dancer: :fire:

## Notifications token

Get a token for CRAN checks notifications.

[Function of the `cchecks` R package: `cchn_register()`](https://docs.ropensci.org/cchecks/reference/cchn_register.html).

`GET [/notifications/token]`

Parameter:

email
: email address

The token is sent by email, not returned via the response body or headers!

```{r results="asis", cache=TRUE}
args <- c("https://cranchecks.info/notifications/token?email=msmaellesalmon@gmail.com")
get_and_show(args)
```

```r
# Interactively
cchecks::cchn_register(email = "jane.doe@cranchecksapidocs.com")
```

```{r, echo=FALSE, message=FALSE}
# Once you have a token
email <- Sys.getenv("CCHECKS_EMAIL")
token <- Sys.getenv("CCHECKS_TOKEN")
cchecks::cchn_register(email = email, token = token)
rules <- cchecks::cchn_rule_list(
  email = "msmaellesalmon@gmail.com",
)$data

for (rule in rules$id) {
  cchecks::cchn_rule_delete(
    id = rule,
    email = "msmaellesalmon@gmail.com"
  )
}

```

## Notifications rules

_This section is not about an endpoint, it is information useful for all notifications endpoint. :nerd:_

:warning: All components of a rule (e.g., status or time) are combined with 'AND'. That is,
if `status="warn"` and `time=3`, the rule is "triggered" only if both
of `status="warn"` and `time=3` components match the cran checks data.

:bulb: If you want achieve 'OR' behavior make multiple rules.

Each rule can have 1 to 4 parameters:

status (str)
: match against check status. one of: ok, note, warn, error, fail

time (int)
: days in a row the match occurs. an integer. can only go 30 days
back (history cleaned up after 30 days)

platforms (str/int)
: platform the status occurs on, including negation (e.g., "-solaris"). options:
solaris, osx, linux, windows, devel, release, patched, oldrel

regex (str)
: a regex to match against the text of an error in check_details.output

Examples in words, and their equivalents as a [Ruby hash](https://ruby-doc.org/core-2.7.0/Hash.html)

ERROR for 3 days in a row across 2 or more platforms
: `{'status' => 'error', 'time' => 3, 'platforms' => 2, 'regex' => nil}`

ERROR for 2 days in a row on all osx platforms
: `{'status' => 'error', 'time' => 2, 'platforms' => "osx", 'regex' => nil}`

ERROR for 2 days in a row on all release R versions
: `{'status' => 'error', 'time' => 2, 'platforms' => "release", 'regex' => nil}`

WARN for 4 days in a row on any platform except Solaris
: `{'status' => 'warn', 'time' => 4, 'platforms' => "-solaris", 'regex' => nil}`

WARN for 2 days in a row across 9 or more platforms
: `{'status' => 'warn', 'time' => 2, 'platforms' => 10, 'regex' => nil}`

NOTE across all osx platforms
: `{'status' => 'note', 'time' => nil, 'platforms' => "osx", 'regex' => nil}`

NOTE
: `{'status' => 'note', 'time' => nil, 'platforms' => nil, 'regex' => nil}`

error details contain regex 'install'
: `{'status' => nil, 'time' => nil, 'platforms' => nil, 'regex' => "install"}`

## Notifications create

Add new notification rules.

[Functions of the `cchecks` R package: `cchn_rule_add()` and `cchn_pkg_rule_add()`](https://docs.ropensci.org/cchecks/reference/cchn_rules.html).

```{r, results="asis"}
args <- c("-XPOST", "-H", paste0('"Authorization: Bearer ', Sys.getenv("CCHECKS_TOKEN"), '"'), "\\\n", "--data", paste0("'", '[{"package": "ropenaq", "regex": "install failure"}]', "'"), "\\\n", "https://cranchecks.info/notifications/rules")
get_and_show(args)
```

```{r, results="asis"}
args <- c("-XPOST", "-H", paste0('"Authorization: Bearer ', Sys.getenv("CCHECKS_TOKEN"), '"'), "\\\n", "--data", paste0("'", '[{"package": "ropenaq", "regex": "install failure"}]', "'"), "\\\n", "https://cranchecks.info/notifications/rules")
get_and_show(args)
```

```{r}
# From anywhere
cchecks::cchn_rule_add(
  email = "msmaellesalmon@gmail.com",
  package = "ropenaq",
  regex = "install failure"
  )

# Inside the ropenaq folder
cchecks::cchn_pkg_rule_add(regex = "install failure")
# A second time
cchecks::cchn_pkg_rule_add(regex = "install failure")
```

## Notifications list

List your notifications rules

[Functions of the `cchecks` R package: `cchn_rule_list()` and `cchn_pkg_rule_list()`](https://docs.ropensci.org/cchecks/reference/cchn_rules.html).

`GET [/notifications/rules]`

```{r, results="asis"}
args <- c("https://cranchecks.info/notifications/rules", "-H", paste0('"Authorization: Bearer ', Sys.getenv("CCHECKS_TOKEN"), '"'))
get_and_show(args)
```

```{r}
# From anywhere
cchecks::cchn_rule_list()

# Inside the ropenaq folder
cchecks::cchn_pkg_rule_list()
```

## Notifications get

Get a notifications rule by ID

[Functions of the `cchecks` R package: `cchn_rule_get()` and `cchn_pkg_rule_get()`](https://docs.ropensci.org/cchecks/reference/cchn_rules.html).

`GET [/notifications/rules/{id}]`

```{r}
Sys.setenv("rule_id" = cchecks::cchn_rule_list()$data$id[1])
```

```{r, results="asis"}
args <- c("-H", paste0('"Authorization: Bearer ', Sys.getenv("CCHECKS_TOKEN"), '"'), "\\\n", paste0("https://cranchecks.info/notifications/rules/", Sys.getenv("rule_id")))
get_and_show(args)
```

```{r}
# From anywhere
rule_id <- cchecks::cchn_rule_list()$data$id[1]
rule_id
cchecks::cchn_rule_get(rule_id)

# Inside the ropenaq folder
rule_id <- cchecks::cchn_pkg_rule_list()$data$id[1]
rule_id
cchecks::cchn_pkg_rule_get(rule_id)
```

## Notifications delete

Delete a notifications rule by ID

[Functions of the `cchecks` R package: `cchn_rule_delete()` and `cchn_pkg_rule_delete()`](https://docs.ropensci.org/cchecks/reference/cchn_rules.html).

`DELETE [/notifications/rules/{id}]`

```{r, include=FALSE}
cchecks::cchn_rule_add(
  email = "msmaellesalmon@gmail.com",
  package = "ropenaq",
  regex = "install failure"
  )
```

```{r}
Sys.setenv("rule_id" = tail(cchecks::cchn_rule_list()$data, n = 1))
```

```{r, results="asis"}
args <- c("-XDELETE", "-H", paste0('"Authorization: Bearer ', Sys.getenv("CCHECKS_TOKEN"), '"'), "\\\n", paste0("https://cranchecks.info/notifications/rules/", Sys.getenv("rule_id")))
get_and_show(args)
```


```{r, include=FALSE}
cchecks::cchn_rule_add(
  email = "msmaellesalmon@gmail.com",
  package = "ropenaq",
  regex = "install failure"
  )


cchecks::cchn_rule_add(
  email = "msmaellesalmon@gmail.com",
  package = "riem",
  regex = "install failure"
  )
```

```{r}
# From anywhere
rule_id <- tail(cchecks::cchn_rule_list()$data$id, n = 1)
rule_id
cchecks::cchn_rule_delete(rule_id)

# Inside the ropenaq folder
rule_id <- tail(cchecks::cchn_rule_list()$data$id, n = 1)
rule_id
cchecks::cchn_pkg_rule_delete(rule_id)
```
